name: Deploy to Lightsail BFF

on:
  push:
    branches:
      - main
    paths:
      - 'lightsail-bff/**'
      - '.github/workflows/deploy-lightsail-bff.yml'

jobs:
  deploy:
    name: Deploy BFF to Lightsail
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare SSH key
        shell: bash
        run: |
          set -euo pipefail

          if [ -z "${{ secrets.LIGHTSAIL_SSH_KEY }}" ]; then
            echo "::error::Missing GitHub secret LIGHTSAIL_SSH_KEY. Set it to your *private* SSH key (OpenSSH format), or a base64-encoded private key."
            exit 1
          fi

          mkdir -p .ssh
          KEY_FILE=".ssh/lightsail.key"

          # Support either a raw multiline private key, or a base64-encoded key.
          if printf '%s' "${{ secrets.LIGHTSAIL_SSH_KEY }}" | grep -q "BEGIN .*PRIVATE KEY"; then
            printf '%s' "${{ secrets.LIGHTSAIL_SSH_KEY }}" > "${KEY_FILE}"
          else
            printf '%s' "${{ secrets.LIGHTSAIL_SSH_KEY }}" | base64 -d > "${KEY_FILE}"
          fi

          # These actions run in Docker containers; if the file is 600, the container user may not
          # have permission to read it. This is still safe on ephemeral GitHub runners.
          chmod 644 "${KEY_FILE}"

      - name: Upload BFF files to Lightsail
        uses: appleboy/scp-action@v0.1.7
        with:
          host: 13.236.58.12
          username: ubuntu
          key_path: .ssh/lightsail.key
          port: 22
          passphrase: ${{ secrets.LIGHTSAIL_SSH_KEY_PASSPHRASE }}
          source: "lightsail-bff/*"
          target: "/home/ubuntu/lightsail-bff"

      - name: Deploy to Lightsail via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: 13.236.58.12
          username: ubuntu
          key_path: .ssh/lightsail.key
          port: 22
          passphrase: ${{ secrets.LIGHTSAIL_SSH_KEY_PASSPHRASE }}
          script_stop: true
          script: |
            echo "üì¶ Deploying BFF from uploaded artefacts..."

            SRC_DIR="/home/ubuntu/lightsail-bff/lightsail-bff"
            if [ ! -d "${SRC_DIR}" ]; then
              echo "‚ùå Uploaded folder not found at ${SRC_DIR}"
              echo "Contents of /home/ubuntu/lightsail-bff:"
              ls -la /home/ubuntu/lightsail-bff || true
              exit 1
            fi

            # Copy BFF files from uploaded folder to app directory
            echo "üìã Syncing BFF files..."
            sudo -u deployer rsync -av --delete --exclude='.env' --exclude='node_modules' "${SRC_DIR}/" /home/deployer/app/ || exit 1
            
            # Install dependencies
            echo "üì¶ Installing dependencies..."
            cd /home/deployer/app
            sudo -u deployer npm ci --production || exit 1
            
            # Restart service
            echo "üîÑ Restarting BFF service..."
            sudo systemctl restart clinicpro-bff || exit 1
            
            # Verify service is running
            echo "‚úÖ Checking service status..."
            sleep 3
            sudo systemctl is-active clinicpro-bff || exit 1
            
            echo "üéâ Deployment successful!"
            echo "Service status:"
            sudo systemctl status clinicpro-bff --no-pager | head -10

      - name: Comment on commit
        uses: peter-evans/commit-comment@v3
        if: success()
        with:
          body: |
            ‚úÖ **Lightsail BFF deployed successfully!**
            
            - Server: 13.236.58.12
            - Service: clinicpro-bff
            - Status: Running
            
            Check deployment logs in [Actions](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
