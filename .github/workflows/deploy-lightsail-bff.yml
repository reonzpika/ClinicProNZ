name: Deploy to Lightsail BFF

on:
  push:
    branches:
      - main
    paths:
      - 'lightsail-bff/**'
      - .github/workflows/deploy-lightsail-bff.yml
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy:
    name: Deploy BFF to Lightsail
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare SSH key
        shell: bash
        run: |
          set -euo pipefail

          if [ -z "${{ secrets.LIGHTSAIL_SSH_KEY }}" ]; then
            echo "::error::Missing GitHub secret LIGHTSAIL_SSH_KEY. Set it to your *private* SSH key (OpenSSH format), or a base64-encoded private key."
            exit 1
          fi

          # NOTE: appleboy/scp-action runs in a container. If we put the key under
          # a restrictive directory (e.g. .ssh with 700 perms), the container user
          # can get "permission denied" reading it. Keep the key in the workspace
          # and make it readable for this ephemeral runner only.
          KEY_FILE="${GITHUB_WORKSPACE}/lightsail.key"

          # Support either a raw multiline private key, or a base64-encoded key.
          if printf '%s' "${{ secrets.LIGHTSAIL_SSH_KEY }}" | grep -q "BEGIN .*PRIVATE KEY"; then
            printf '%s' "${{ secrets.LIGHTSAIL_SSH_KEY }}" > "${KEY_FILE}"
          else
            printf '%s' "${{ secrets.LIGHTSAIL_SSH_KEY }}" | base64 -d > "${KEY_FILE}"
          fi

          # Readable by the scp/ssh action containers.
          chmod a+r "${KEY_FILE}"

      - name: Upload BFF files to Lightsail
        uses: appleboy/scp-action@v0.1.7
        with:
          host: 13.236.58.12
          username: ubuntu
          key_path: lightsail.key
          port: 22
          passphrase: ${{ secrets.LIGHTSAIL_SSH_KEY_PASSPHRASE }}
          source: 'lightsail-bff/*'
          target: '/tmp/clinicpro-bff-staging-${{ github.sha }}'

      - name: Deploy to Lightsail via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: 13.236.58.12
          username: ubuntu
          key_path: lightsail.key
          port: 22
          passphrase: ${{ secrets.LIGHTSAIL_SSH_KEY_PASSPHRASE }}
          script_stop: true
          script: |
            set -euo pipefail

            echo "üì¶ Deploying BFF from uploaded artefacts..."

            DEPLOY_SHA="${{ github.sha }}"
            STAGING_DIR="/tmp/clinicpro-bff-staging-${DEPLOY_SHA}"

            cleanup() {
              sudo rm -rf "${STAGING_DIR}" || true
            }
            trap cleanup EXIT

            if [ ! -d "${STAGING_DIR}" ]; then
              echo "‚ùå Staging directory not found: ${STAGING_DIR}"
              echo "Contents of /tmp (for debugging):"
              ls -la /tmp || true
              exit 1
            fi

            # Ensure deployer can traverse/read the staged artefacts.
            sudo chmod -R a+rX "${STAGING_DIR}" || true

            # Defensive handling for SCP layouts (flat vs nested lightsail-bff/).
            if [ -d "${STAGING_DIR}/lightsail-bff" ]; then
              SRC_DIR="${STAGING_DIR}/lightsail-bff"
            else
              SRC_DIR="${STAGING_DIR}"
            fi

            if [ ! -f "${SRC_DIR}/package.json" ]; then
              echo "‚ùå package.json not found in expected source directory: ${SRC_DIR}"
              echo "Contents of ${STAGING_DIR}:"
              ls -la "${STAGING_DIR}" || true
              exit 1
            fi

            echo "üìã Syncing BFF files into /home/deployer/app..."
            sudo -u deployer rsync -a --delete \
              --exclude='.env' \
              --exclude='node_modules' \
              --exclude='.git' \
              --exclude='.github' \
              "${SRC_DIR}/" /home/deployer/app/

            echo "üì¶ Installing production dependencies..."
            cd /home/deployer/app
            sudo -u deployer npm ci --production --no-audit

            echo "üîÑ Restarting BFF service..."
            sudo systemctl restart clinicpro-bff

            echo "‚úÖ Verifying service is active..."
            sleep 3
            if ! sudo systemctl is-active --quiet clinicpro-bff; then
              echo "‚ùå Service clinicpro-bff is not active."
              sudo systemctl status clinicpro-bff --no-pager -l || true
              sudo journalctl -u clinicpro-bff -n 50 --no-pager || true
              exit 1
            fi

            echo "üéâ Deployment successful!"

      - name: Comment on commit
        uses: peter-evans/commit-comment@v3
        if: success()
        continue-on-error: true
        with:
          sha: ${{ github.sha }}
          body: |
            ‚úÖ **Lightsail BFF deployed successfully!**

            - Server: 13.236.58.12
            - Service: clinicpro-bff
            - Status: Running

            Check deployment logs in [Actions](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

      - name: Cleanup runner SSH key
        if: always()
        shell: bash
        run: |
          rm -f "${GITHUB_WORKSPACE}/lightsail.key"
