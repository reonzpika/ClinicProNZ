# ConsultAI NZ - Phase 1 PRD: Enhanced Note Generation System
Version: 1.0
Last Updated: 2024-03-21

## 1. Product Overview

### 1.1 Product Vision
Transform medical consultation documentation in New Zealand primary care through an intelligent, context-aware note generation system that reduces cognitive load while maintaining clinical accuracy.

### 1.2 Target Users
- Primary: General Practitioners in New Zealand
- Secondary: Nurse Practitioners, Urgent Care Physicians
- Tertiary: Practice Nurses, Medical Specialists

### 1.3 Key Problems Addressed
1. Inefficient consultation documentation
2. Cognitive burden during note-taking
3. Inconsistent note structure
4. Time spent on administrative tasks
5. Variable note quality

## 2. Core Features

### 2.1 Modular Prompt System

#### 2.1.1 System Architecture
- Implement a hierarchical prompt management system
- Create separate directories for different prompt types
- Enable dynamic prompt assembly based on context

#### 2.1.2 Prompt Categories
1. Base Prompts
   - Clinical context (NZ Primary Care)
   - Medical standards (NZ Guidelines)
   - System context (NZ Health System)
   - Privacy requirements (NZ Privacy Act)

2. Functional Prompts
   - Input processing
   - Analysis instructions
   - Output formatting
   - Style guidelines

#### 2.1.3 Technical Requirements
- File-based prompt storage system
- Version control for prompts
- Easy prompt modification interface
- Prompt validation system

### 2.2 Enhanced SOAP Template System

#### 2.2.1 Multi-Problem Structure
1. Problem List Management
   - Active problems (Acute/Chronic)
   - Inactive problems
   - Prevention/Screening items

2. Per-Problem Components
   - Subjective data
   - Objective findings
   - Assessment details
   - Management plan

#### 2.2.2 Template Features
- Automatic problem detection
- Problem prioritization
- Cross-problem relationships
- Preventive care integration

#### 2.2.3 Technical Requirements
- Template storage system
- Template versioning
- Quick template switching
- Template preview functionality

### 2.3 Analysis Levels

#### 2.3.1 Level Definitions
1. Level 1: Facts Only
   - Pure information extraction
   - Basic organization
   - No clinical interpretation

2. Level 2: Basic Analysis
   - Pattern recognition
   - Basic clinical correlations
   - Standard care pathways

3. Level 3: Clinical Insights
   - Evidence-based suggestions
   - Risk assessment
   - Common differentials

#### 2.3.2 Technical Requirements
- One-click level selection
- Visual level indicators
- Easy level switching
- Preview functionality

### 2.4 Quick Settings Interface

#### 2.4.1 Core Components
1. Template Controls
   - Auto-detection
   - Quick switching
   - Preview function

2. Analysis Controls
   - Level selection
   - Toggle switches
   - Preview differences

3. Output Controls
   - Conciseness settings
   - Format options
   - Emphasis areas

#### 2.4.2 Technical Requirements
- Intuitive UI/UX
- Single-click workflows
- Context-aware defaults
- Undo/redo functionality

## 2. Current System Architecture

### 2.0.1 Existing File Structure
```
src/
├── components/
│   ├── AudioRecorder.tsx        # Handles consultation recording
│   ├── LiveTranscript.tsx       # Shows real-time transcription
│   ├── TemplateSelector.tsx     # Template selection interface
│   ├── StructuredNote.tsx       # Displays generated notes
│   ├── TemplateManagementInterface.tsx  # Template CRUD operations
│   └── note-generator/          # Note generation components
├── hooks/
│   └── useNoteGeneration.ts     # Core note generation logic
├── config/
│   └── noteTemplates.ts         # Template definitions
└── types/
    └── index.ts                 # Type definitions
```

### 2.0.2 Core Hooks and Functions
1. useNoteGeneration Hook
   - Current Location: src/hooks/useNoteGeneration.ts
   - Core Functionality:
     - Manages note generation state
     - Handles API calls to OpenAI
     - Processes transcripts
     - Applies templates
   - Key States:
     - isGenerating
     - error
     - generateNotes function

2. Template Management
   - Current Location: src/components/TemplateManagementInterface.tsx
   - Features:
     - CRUD operations for templates
     - Template preview
     - Template selection
   - Database Integration:
     - Template storage
     - Version control
     - User preferences

### 2.0.3 Compatibility Requirements
1. API Endpoints
   - Maintain current endpoint structure:
     - /api/generate-notes
     - /api/templates
   - Preserve request/response formats

2. State Management
   - Continue using React hooks pattern
   - Maintain existing state structures
   - Ensure backward compatibility

3. Component Integration
   - Preserve current component hierarchy
   - Maintain existing prop interfaces
   - Keep current event handling patterns

4. Type Definitions
   - Extend existing types
   - Maintain backward compatibility
   - Document type changes

## 3. Technical Specifications

### 3.1 Frontend Requirements
- Next.js 14 (App Router)
- TypeScript
- Shadcn UI + Radix UI
- Tailwind CSS
- React Server Components where appropriate

### 3.2 Backend Requirements
- API Routes for prompt processing
- Secure prompt storage
- Template management system
- User preference storage

### 3.3 Integration Requirements
- Deepgram for transcription
- OpenAI o4-mini model for analysis https://platform.openai.com/docs/models/o4-mini
  - Optimized for speed and cost-efficiency
  - Context window: 8K tokens
  - Response format: JSON mode for structured output
  - Temperature: 0.3 for consistent medical notes
  - Function calling enabled for structured outputs
- Local storage for preferences
- API caching system

### 3.4 Performance Requirements
- Note generation with o4-mini: < 2 seconds
- UI interactions: < 100ms
- Template switching: < 200ms
- Analysis level changes: < 500ms
- Cost per consultation target: < $0.05 USD

### 3.5 Model-Specific Optimizations
1. Prompt Engineering
   - Compact, efficient prompts optimized for o4-mini
   - Structured JSON outputs for consistent formatting
   - Clear instruction sets for medical terminology
   - Minimal token usage while maintaining accuracy

2. Response Handling
   - Efficient parsing of JSON responses
   - Graceful fallback for incomplete responses
   - Smart chunking for longer consultations
   - Response validation and error handling

3. Cost Management
   - Token usage monitoring
   - Batch processing where appropriate
   - Caching frequently used responses
   - Smart context window management

## 4. User Experience Requirements

### 4.1 Core Principles
- Minimize cognitive load
- Reduce clicks/interactions
- Provide immediate feedback
- Maintain clinical focus

### 4.2 Interface Requirements
- Clean, medical-appropriate design
- Clear visual hierarchy
- Consistent interaction patterns
- Accessible interface

### 4.3 Workflow Integration
- Seamless consultation flow
- Natural interaction points
- Minimal disruption
- Easy error recovery

## 5. Security and Compliance

### 5.1 Privacy Requirements
- NZ Privacy Act 2020 compliance
- Health Information Privacy Code
- Secure data handling
- Audit trail capability

### 5.2 Clinical Safety
- Clinical accuracy validation
- Error prevention systems
- Clear warning systems
- Version control

## 6. Success Metrics

### 6.1 Performance Metrics
- Note generation speed
- Accuracy of problem detection
- Template usage rates
- Analysis level utilization

### 6.2 User Metrics
- Time saved per consultation
- User satisfaction scores
- Feature adoption rates
- Error correction rates

## 7. Development Milestones

### 7.1 Phase 1A (Weeks 1-2)
- Set up prompt management system
- Implement basic SOAP template
- Create file structure
- Establish API endpoints

### 7.2 Phase 1B (Weeks 3-4)
- Develop analysis levels
- Build quick settings UI
- Implement template switching
- Add basic preferences

### 7.3 Phase 1C (Weeks 5-6)
- Integrate all components
- Implement caching
- Add error handling
- Performance optimization

### 7.4 Phase 1D (Weeks 7-8)
- User testing
- Bug fixes
- Performance tuning
- Documentation

## 8. Future Considerations

### 8.1 Planned Enhancements
- Custom template creation
- Advanced analysis levels
- Integration with PMS
- Mobile companion app

### 8.2 Scalability Plans
- Multi-tenant support
- Template sharing
- Advanced analytics
- Machine learning improvements

## 9. Dependencies

### 9.1 External Services
- Deepgram API
- OpenAI API
- Authentication service
- Storage service

### 9.2 Internal Systems
- Template management
- Prompt management
- User preferences
- Caching system

## 10. Risks and Mitigation

### 10.1 Technical Risks
- API reliability
- Performance issues
- Integration challenges
- Scaling problems

### 10.2 Clinical Risks
- Accuracy concerns
- Privacy breaches
- Compliance issues
- User adoption

### 10.3 Mitigation Strategies
- Robust testing
- Regular audits
- User feedback loops
- Performance monitoring

## 11. Success Criteria

### 11.1 MVP Requirements
- Functional note generation
- Working analysis levels
- Basic template system
- Quick settings interface

### 11.2 Quality Gates
- Performance benchmarks met
- Security requirements satisfied
- User acceptance achieved
- Compliance verified

## 12. Documentation Requirements

### 12.1 Technical Documentation
- Architecture overview
- API documentation
- Component documentation
- Integration guides

### 12.2 User Documentation
- User guides
- Quick start guides
- Feature documentation
- Troubleshooting guides

## 13. Implementation Details

### 13.1 File Structure Changes
```
src/
├── prompts/                     # New directory for prompt system
│   ├── base/                   # Base prompt templates
│   │   ├── clinical-context.md
│   │   ├── medical-standards.md
│   │   └── privacy-requirements.md
│   ├── functional/             # Functional prompts
│   │   ├── input-processing.md
│   │   ├── analysis.md
│   │   └── formatting.md
│   └── templates/              # Note templates
│       ├── multi-problem-soap.md
│       └── specialized/
├── components/
│   ├── prompt-management/      # New prompt management components
│   └── template-management/    # Restructured template components
└── types/
    ├── prompts.ts             # Prompt-related types
    └── templates.ts           # Template-related types
```

### 13.2 Database Schema
```sql
-- Template Storage
CREATE TABLE templates (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    content TEXT NOT NULL,
    type VARCHAR(50) NOT NULL,
    version INT DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Prompt Storage
CREATE TABLE prompts (
    id SERIAL PRIMARY KEY,
    category VARCHAR(50) NOT NULL,
    name VARCHAR(255) NOT NULL,
    content TEXT NOT NULL,
    version INT DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 13.3 API Endpoints Specification
```typescript
// Template Management
POST /api/templates
  body: { name: string, content: string, type: string }
  response: Template

PUT /api/templates/:id
  body: { name?: string, content?: string, type?: string }
  response: Template

// Prompt Management
GET /api/prompts/:category
  response: Prompt[]

// Note Generation
POST /api/generate-notes
  body: {
    transcript: string,
    templateId: string,
    analysisLevel: 'facts' | 'basic' | 'clinical',
    conciseLevel: 'detailed' | 'concise' | 'bullet-points'
  }
  response: GeneratedNote
```

### 13.4 Core Type Definitions
```typescript
interface Template {
  id: number;
  name: string;
  content: string;
  type: string;
  version: number;
  createdAt: Date;
  updatedAt: Date;
}

interface Prompt {
  id: number;
  category: string;
  name: string;
  content: string;
  version: number;
}

interface GeneratedNote {
  sections: Array<{
    key: string;
    content: string;
  }>;
  metadata: {
    analysisLevel: string;
    templateUsed: string;
    generatedAt: Date;
  };
}
```

### 13.5 State Management Flow
```mermaid
graph TD
    A[User Input] --> B[Template Selection]
    B --> C[Analysis Level Selection]
    C --> D[Note Generation]
    D --> E[Preview/Edit]
    E --> F[Save/Export]

    B --> G[Template Management]
    G --> H[Template CRUD]
    H --> B

    D --> I[Error Handling]
    I --> J[Retry/Fallback]
    J --> D
```

### 13.6 Dependency Versions
```json
{
  "dependencies": {
    "next": "14.1.0",
    "react": "18.2.0",
    "openai": "^4.28.0",
    "deepgram": "^1.0.3",
    "@radix-ui/react": "^1.0.0",
    "tailwindcss": "^3.3.0",
    "typescript": "^5.0.0"
  }
}
```

## 14. Example Prompt Content

### 14.1 Base Prompts

#### Clinical Context (clinical-context.md)
```markdown
You are an AI medical scribe assisting a GP in New Zealand primary care. Your role is to:
- Process consultation transcripts according to NZ medical standards
- Use NZ-specific medical terminology and classifications
- Follow RNZCGP documentation guidelines
- Consider NZ healthcare system context
- Respect patient privacy per NZ Privacy Act

Key Considerations:
- ACC claim requirements
- Special Authority criteria
- PHO enrollment status
- NZ formulary medications
- Local HealthPathways

Output Format: Always structure responses in valid JSON format.
```

#### Medical Standards (medical-standards.md)
```markdown
Follow these NZ-specific medical documentation standards:
- Use READ codes for diagnoses where applicable
- Follow NZULM medication naming conventions
- Apply SNOMED-CT NZ Edition terminology
- Use NZ pathology coding standards
- Follow NZ radiology referral guidelines

Classification Priorities:
1. ACC claim categories
2. Long-term condition codes
3. High-risk condition flags
4. Screening program codes
5. Immunisation schedule codes

Response Requirements:
- Include relevant codes in output
- Flag any non-standard terminology
- Note any classification ambiguities
```

### 14.2 Functional Prompts

#### Input Processing (input-processing.md)
```markdown
Process the consultation transcript with these rules:
1. Problem Identification
   - Identify chief complaints
   - Note secondary issues
   - Flag preventive care opportunities
   - Detect urgent/emergency indicators

2. Information Extraction
   - Patient-reported symptoms
   - Timing and progression
   - Impact on daily activities
   - Previous treatments
   - Risk factors

3. Clinical Data
   - Vital signs
   - Examination findings
   - Test results
   - Treatment responses

Format Requirements:
- Group by problem
- Maintain chronological order
- Preserve clinical context
- Flag inconsistencies
```

#### Analysis (analysis.md)
```markdown
Analysis Level: {level}

Facts Only:
- Extract explicit information only
- No clinical interpretation
- Direct symptom mapping
- Objective findings only

Basic Analysis:
- Pattern recognition
- Basic clinical correlations
- Standard care pathways
- Common risk factors

Clinical Insights:
- Evidence-based suggestions
- Risk stratification
- Differential diagnoses
- Management options

Output Structure:
{
  "problems": [{
    "type": "primary|secondary|preventive",
    "description": string,
    "details": {
      "symptoms": string[],
      "findings": string[],
      "analysis": string,
      "suggestions": string[]
    }
  }]
}
```

### 14.3 Template Examples

#### Multi-Problem SOAP (multi-problem-soap.md)
```markdown
Structure the consultation note as follows:

For each identified problem:

SUBJECTIVE:
- Present illness details
- Symptom progression
- Impact assessment
- Patient concerns

OBJECTIVE:
- Vital signs
- Examination findings
- Investigation results
- Clinical measurements

ASSESSMENT:
- Clinical reasoning
- Diagnosis status
- Problem status
- Risk evaluation

PLAN:
- Management steps
- Medications
- Investigations
- Follow-up
- Patient education

Output Format:
{
  "problems": [{
    "priority": number,
    "soap": {
      "subjective": string,
      "objective": string,
      "assessment": string,
      "plan": string
    }
  }],
  "preventive": {
    "screenings": string[],
    "immunizations": string[],
    "lifestyle": string[]
  }
}
```

### 14.4 Specialized Templates

#### Driver's License Medical (drivers-medical.md)
```markdown
Focus Areas:
1. Visual acuity and fields
2. Cardiovascular status
3. Neurological function
4. Medication effects
5. Medical conditions affecting driving

Required Sections:
- Identity verification
- Medical history review
- System examination
- Fitness assessment
- Restrictions/Conditions

Output Format:
{
  "identification": {
    "verified": boolean,
    "method": string
  },
  "assessment": {
    "visualAcuity": string,
    "medicalConditions": string[],
    "medicationEffects": string,
    "fitnessLevel": string
  },
  "recommendations": {
    "restrictions": string[],
    "duration": string,
    "conditions": string[]
  }
}
```

### 14.5 Response Formatting

#### Formatting Rules
```markdown
General Rules:
- Use consistent medical terminology
- Apply standard abbreviations
- Maintain professional tone
- Be concise but complete
- Flag critical information

JSON Structure:
{
  "metadata": {
    "templateType": string,
    "analysisLevel": string,
    "timestamp": string
  },
  "content": {
    // Template-specific structure
  },
  "alerts": {
    "critical": string[],
    "warnings": string[],
    "info": string[]
  }
}
``` 