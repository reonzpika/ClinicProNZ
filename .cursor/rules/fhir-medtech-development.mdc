---
description: Medtech ALEX (FHIR) development guidelines (practical, no MCP)
globs:
  - "app/**/medtech/**"
  - "app/api/**/medtech/**"
  - "src/medtech/**"
  - "src/lib/services/medtech/**"
  - "lightsail-bff/**"
  - "project-management/medtech-integration/**"
---

# Medtech ALEX (FHIR) development guidelines

This rule auto-activates when working with Medtech/ALEX integration files.

## Canonical documentation (do not duplicate)

- **ALEX docs (canonical)**: `https://alexapidoc.medtechglobal.com/#high-level-design-for-medtech-fhir-api-alex`
- **Local runbook (this repo)**: `project-management/medtech-integration/PROJECT_SUMMARY.md`

Keep local docs short; store only “our conventions”, “known gotchas”, and “how to debug quickly”.

## Hard constraints (architecture)

- **Only the Lightsail BFF calls ALEX** (static IP allow-listed). Vercel must not call ALEX directly.
- **Facility ID matters end-to-end** (widget → Vercel → BFF → ALEX header `mt-facilityid`).

## ALEX request basics (what must be correct)

- **Base URLs**:
  - UAT: `https://alexapiuat.medtechglobal.com/FHIR`
  - Production: `https://alexapi.medtechglobal.com/FHIR`
- **Required headers**:
  - `Authorization: Bearer <token>`
  - `Content-Type: application/fhir+json` (required for POST/PUT/PATCH; safe for GET too)
  - `mt-facilityid: <FACILITY>`
- **Recommended header (debugging)**:
  - `mt-correlationid: <uuid>`; helps Medtech trace in logs.

## Known ALEX UAT gotchas (important)

- **URL shape matters**: ensure you are not double-appending `/FHIR` and keep the case consistent.
- **Search query shape matters**: do not assume a 403 is “missing roles” until you’ve tried the documented query form.
  - Known working: `GET /FHIR/Patient?identifier=<system>|<value>`
  - For Media: `GET /FHIR/Media?patient.identifier=<system>|<value>` (per ALEX support).

## Images widget rules (ALEX-specific)

- **Image size**: enforce `< 1MB` before POST.
- **FHIR Media**:
  - `Media.identifier` is mandatory on POST.
  - Use `content.data` base64 (per our current implementation).
  - Treat Media as effectively immutable post-commit.

## Quick debugging flow (preferred)

- BFF health: `GET https://api.clinicpro.co.nz/health`
- Patient test: `GET https://api.clinicpro.co.nz/api/medtech/test?nhi=<NHI>&facilityId=<FACILITY>`
- Media verify: `GET https://api.clinicpro.co.nz/api/medtech/media?nhi=<NHI>&facilityId=<FACILITY>&count=<N>`

When debugging 403s:
- Confirm facility ID and base URL first.
- Then confirm the query parameter format matches the ALEX docs (and any ALEX support examples).

## Implementation hygiene

- Keep a small number of “known-good” curl/Postman requests checked in (or in `PROJECT_SUMMARY.md`) for fast regression tests.
- Prefer adding small, purpose-built BFF endpoints for validation over ad-hoc scripts.

*** End of File
