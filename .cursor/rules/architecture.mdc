---
description: Architecture â€” enforce scalable, secure, modular ClinicPro structure
globs: ["src/**", "db/**", "api/**"]
alwaysApply: true
---

# ClinicPro Architecture Guide

## ğŸ¯ Architectural Principles

- Design for a **lightweight**, **scalable**, and **secure** SaaS architecture.
- Architecture must support **low maintenance overhead** and clear extensibility.
- **Feature-based organization** over technical layer separation
- **RBAC-first design** with role checks embedded throughout
- **Type safety** enforced at all levels (no `any` types)

## ğŸ—ï¸ Technology Stack

```
Frontend:     Next.js 15 + React 19 + TypeScript + Tailwind CSS
Auth:         Clerk with RBAC (public â†’ signed_up â†’ standard â†’ admin)
Database:     Neon PostgreSQL + Drizzle ORM + pgvector (RAG)
AI Services:  OpenAI GPT-4o, Anthropic Claude, Deepgram transcription
Storage:      AWS S3 + presigned URLs
Real-time:    Ably for live transcription sync
Payments:     Stripe subscription management
Deployment:   Vercel + Edge functions
```

### Frontend Architecture
- **Next.js 15 App Router**: Route groups for business domain organization
- **React 19**: Latest features with concurrent rendering
- **TypeScript**: Strict mode with comprehensive type safety
- **Tailwind CSS**: Utility-first styling with NZ-themed design system
- **Radix UI**: Accessible component primitives

### Backend Architecture  
- **API Routes**: Mirror page structure for consistency
- **Middleware**: Clerk-based authentication with RBAC enforcement
- **Edge Functions**: Low-latency API responses via Vercel
- **Webhooks**: External service integration (Stripe, Clerk)

### Database Architecture
- **Neon PostgreSQL**: Managed database with connection pooling
- **Drizzle ORM**: Type-safe database operations
- **pgvector Extension**: Vector embeddings for RAG system
- **Schema Modularity**: Business domain separation

### AI/ML Architecture
- **OpenAI Integration**: GPT-4o for clinical note generation
- **RAG System**: Clinical guidelines with vector similarity search
- **Deepgram**: Real-time medical transcription
- **Image Analysis**: GPT-4o vision for clinical images

## ğŸ“ Project Structure (Feature-Based)

### Root Directory
```
ClinicPro/
â”œâ”€â”€ .cursor/rules/              # AI development guidelines & patterns
â”œâ”€â”€ app/                        # Next.js 15 App Router (pages & API routes)
â”œâ”€â”€ src/                        # Application source code
â”œâ”€â”€ database/                   # Database schema & migrations
â”œâ”€â”€ docs/                       # Technical documentation
â”œâ”€â”€ public/                     # Static assets
â”œâ”€â”€ types/                      # Global TypeScript definitions
â””â”€â”€ config files               # Build & dev configuration
```

### App Router Structure (Route Groups)
```
app/
â”œâ”€â”€ (admin)/                    # Admin-only pages
â”‚   â”œâ”€â”€ admin/                 # User management, system config
â”‚   â””â”€â”€ emergency-admin/       # Emergency access tools
â”œâ”€â”€ (business)/                 # Business logic pages
â”‚   â”œâ”€â”€ billing/               # Subscription management
â”‚   â”œâ”€â”€ pricing/               # Pricing information
â”‚   â””â”€â”€ templates/             # Template management UI
â”œâ”€â”€ (clinical)/                 # Core clinical features
â”‚   â”œâ”€â”€ ai-scribing/           # AI transcription interface
â”‚   â”œâ”€â”€ consultation/          # Main consultation workflow
â”‚   â”œâ”€â”€ differential-diagnosis/ # Clinical decision support
â”‚   â”œâ”€â”€ image/                 # Clinical image analysis
â”‚   â””â”€â”€ reference/             # Clinical reference materials
â”œâ”€â”€ (integration)/              # External integrations
â”‚   â””â”€â”€ mobile/                # Mobile recording interface
â”œâ”€â”€ (legal)/                    # Legal & compliance pages
â”‚   â”œâ”€â”€ privacy/               # Privacy policy
â”‚   â”œâ”€â”€ privacy-info/          # Privacy information
â”‚   â””â”€â”€ terms/                 # Terms of service
â”œâ”€â”€ (marketing)/                # Marketing & landing pages
â”‚   â”œâ”€â”€ about/                 # About page
â”‚   â”œâ”€â”€ clinicpro/             # Product landing
â”‚   â”œâ”€â”€ contact/               # Contact information
â”‚   â”œâ”€â”€ landing-page/          # Main landing page
â”‚   â”œâ”€â”€ roadmap/               # Product roadmap
â”‚   â””â”€â”€ thank-you/             # Post-signup confirmation
â”œâ”€â”€ (user)/                     # User-specific pages
â”‚   â”œâ”€â”€ auth/                  # Authentication flows
â”‚   â”œâ”€â”€ dashboard/             # User dashboard
â”‚   â””â”€â”€ settings/              # User settings
â”œâ”€â”€ api/                        # API routes (mirrors page structure)
â””â”€â”€ globals.css, layout.tsx, page.tsx  # Root app files
```

### Source Code Organization
```
src/
â”œâ”€â”€ features/                   # Feature-based modules
â”‚   â”œâ”€â”€ clinical/              # Clinical workflow features
â”‚   â”‚   â”œâ”€â”€ main-ui/           # Core consultation interface
â”‚   â”‚   â”œâ”€â”€ mobile/            # Mobile recording components
â”‚   â”‚   â”œâ”€â”€ right-sidebar/     # Clinical decision support
â”‚   â”‚   â””â”€â”€ session-management/ # Patient session handling
â”‚   â”œâ”€â”€ marketing/             # Marketing features
â”‚   â”‚   â””â”€â”€ roadmap/           # Product roadmap & feedback
â”‚   â”œâ”€â”€ templates/             # Template management
â”‚   â”‚   â”œâ”€â”€ components/        # Template UI components
â”‚   â”‚   â”œâ”€â”€ hooks/             # Template-specific hooks
â”‚   â”‚   â””â”€â”€ utils/             # Template processing logic
â”‚   â””â”€â”€ user/                  # User management features
â”‚       â””â”€â”€ dashboard/         # User dashboard components
â”œâ”€â”€ shared/                     # Shared application code
â”‚   â”œâ”€â”€ components/            # Reusable UI components
â”‚   â”‚   â”œâ”€â”€ ui/                # Base UI components (Radix)
â”‚   â”‚   â”œâ”€â”€ admin/             # Admin-specific components
â”‚   â”‚   â”œâ”€â”€ billing/           # Billing components
â”‚   â”‚   â”œâ”€â”€ landing-page/      # Landing page sections
â”‚   â”‚   â””â”€â”€ layout/            # Layout components
â”‚   â”œâ”€â”€ hooks/                 # Shared React hooks
â”‚   â”œâ”€â”€ services/              # External service integrations
â”‚   â”œâ”€â”€ contexts/              # React context providers
â”‚   â”œâ”€â”€ types/                 # Shared TypeScript types
â”‚   â””â”€â”€ utils/                 # Utility functions
â””â”€â”€ lib/                        # Core libraries
    â”œâ”€â”€ rag/                   # RAG system implementation
    â”œâ”€â”€ services/              # Service layer abstractions
    â””â”€â”€ utils.ts               # Core utility functions
```

### Database Structure
```
database/
â”œâ”€â”€ schema/                     # Drizzle schema definitions
â”‚   â”œâ”€â”€ index.ts               # Schema exports
â”‚   â”œâ”€â”€ users.ts               # User data & metadata
â”‚   â”œâ”€â”€ patient_sessions.ts    # Consultation sessions
â”‚   â”œâ”€â”€ templates.ts           # Clinical templates
â”‚   â”œâ”€â”€ rag.ts                 # RAG documents & embeddings
â”‚   â”œâ”€â”€ mobile_tokens.ts       # Mobile recording tokens
â”‚   â”œâ”€â”€ user_settings.ts       # User preferences
â”‚   â”œâ”€â”€ feature_requests.ts    # Product feedback
â”‚   â”œâ”€â”€ features.ts            # Product roadmap features
â”‚   â”œâ”€â”€ votes.ts               # Feature voting system
â”‚   â””â”€â”€ email_captures.ts      # Marketing email list
â”œâ”€â”€ migrations/                 # Database migrations
â”‚   â”œâ”€â”€ *.sql                  # Generated SQL migrations
â”‚   â””â”€â”€ meta/                  # Migration metadata
â”œâ”€â”€ client.ts                   # Database connection
â””â”€â”€ seed-templates-new.ts      # Default template seeding
```

## ğŸ›ï¸ Architectural Patterns

### Feature-Based Organization
- **Business domain grouping**: Clinical, templates, user, marketing
- **Vertical slicing**: Each feature contains components, hooks, utils
- **Shared code separation**: Common functionality in `src/shared/`
- **Import path consistency**: Relative paths for database, aliases for app code

### Route Group Strategy
- **URL-agnostic organization**: `(admin)`, `(clinical)`, `(business)` groups
- **API mirroring**: API routes mirror page structure for consistency
- **Role-based access**: Group-level protection via middleware
- **Clear boundaries**: Logical separation without URL impact

### RBAC Architecture
- **Middleware enforcement**: Route-level protection at edge
- **Context extraction**: Support for authenticated users + guest tokens
- **Usage tracking**: Tier-based limits with real-time enforcement
- **Type safety**: Proper Clerk metadata typing throughout

### Database Patterns
- **Schema modularity**: Business domain separation
- **Relationship design**: User-centric with guest token support
- **JSON storage**: Text fields with application-level parsing
- **Migration strategy**: Generated SQL with metadata tracking

### Security Architecture
- **Authentication**: Clerk with custom metadata
- **Authorization**: Role-based with usage limits
- **Data encryption**: End-to-end for patient data
- **Privacy compliance**: NZ Privacy Act 2020 adherence
- **Audit trails**: All patient data access logged

## ğŸš€ Deployment Architecture

### Vercel Edge Network
- **Global distribution**: Edge functions for low latency
- **Automatic scaling**: Zero-config horizontal scaling
- **Environment separation**: Development, staging, production
- **CI/CD integration**: GitHub-triggered deployments

### Database & Storage
- **Neon PostgreSQL**: Managed database with branching
- **AWS S3**: File storage with presigned URLs
- **Connection pooling**: Managed by Neon
- **Backup strategy**: Automated by Neon

### Monitoring & Observability
- **Structured logging**: Pino with Logtail integration
- **Error tracking**: Built-in Next.js error boundaries
- **Performance monitoring**: Vercel analytics
- **Usage metrics**: Custom tracking for RBAC limits

## âš ï¸ Architectural Constraints

### Performance Constraints
- **Database queries**: Optimize for Neon connection limits
- **AI API calls**: Rate limiting and retry mechanisms
- **File uploads**: 10MB limit for clinical images
- **Real-time sync**: Ably channel limitations

### Security Constraints
- **Role validation**: Every API route must check permissions
- **Guest tokens**: 24-hour expiration for anonymous users
- **Patient data**: Encryption at rest and in transit
- **Audit requirements**: All clinical actions logged

### Scalability Constraints
- **Solo GP focus**: Architecture optimized for small practices
- **Usage limits**: Tier-based restrictions prevent abuse
- **AI costs**: Token usage tracking for cost control
- **Database size**: Managed growth with data retention policies

## ğŸ” Common Architectural Pitfalls

### Import Path Issues
- **âŒ Avoid**: Using `@/client` for database imports
- **âœ… Use**: Relative paths for database: `../../../database/client`
- **âŒ Avoid**: Mixing path aliases with relative imports
- **âœ… Use**: Consistent patterns per code category

### RBAC Violations
- **âŒ Avoid**: Direct metadata access without type checking
- **âœ… Use**: `useClerkMetadata` hook for type safety
- **âŒ Avoid**: Skipping usage limit checks
- **âœ… Use**: `enforceUsageLimit` before feature access

### Feature Coupling
- **âŒ Avoid**: Cross-feature dependencies
- **âœ… Use**: Shared code via `src/shared/`
- **âŒ Avoid**: Mixing business domains in components
- **âœ… Use**: Clear feature boundaries with well-defined interfaces
